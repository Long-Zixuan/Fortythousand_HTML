<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>四万万华镜</title>
    <link rel="shortcut icon" href="./src/img/foutyThousandico.ico" >
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        #gameContainer {
            width: 400px;
            height: 600px;
            background: #000033;
            background-image: url('./src/img/background.jpg');
            background-repeat: repeat;
            background-attachment: fixed;
            background-size: cover;
            position: relative;
            overflow: hidden;
            margin: 20px auto;
        }
        #plane {
            width: 50px;
            height: 50px;
            position: absolute;
            bottom: 50px;
            left: 175px;
        }
        #boss {
            width: 50px;
            height: 50px;
            position: absolute;
            bottom: 50px;
            left: 175px;
        }
        .bullet {
            width: 10px;
            height: 20px;
            position: absolute;
            z-index: 10;
        }
        .enemy {
            width: 40px;
            height: 40px;
            position: absolute;
        }
        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 20px;
            z-index: 100;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }
        #enemyHealth {
            position: absolute;
            top: 50px;
            left: 10px;
            color: white;
            font-size: 20px;
            z-index: 100;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }
        #instructions {
            text-align: center;
            margin: 10px;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }
    </style>
</head>
<body>
<div id="instructions">
    方向键移动，按住空格键连续发射三发子弹
</div>
<div id="gameContainer">
    <div id="score">敌人血量: <span id="enemyHealthValue">100</span></div>
    <div id="enemyHealth">玩家血量: <span id="playerHealthValue">100</span></div>
    <img id="plane" src="./src/img/character1.gif" alt="Vivi">
    <img id="boss" src="./src/img/boss.gif" alt="Boss">
</div>

<script>
    const plane = document.getElementById('plane');
    const boss = document.getElementById('boss');
    const gameContainer = document.getElementById('gameContainer');
    const bossHealthElement = document.getElementById('enemyHealthValue');
    const playerHealthElement = document.getElementById('playerHealthValue');

    let planeLeft = 175;
    let planeTop = 500;

    let bossLeft = 175;
    let bossTop = 50;

    let startBossHealth = 100; // 初始Boss血量
    let bossHealth = startBossHealth; // 初始Boss血量
    let startPlayerHealth = 100; // 初始玩家血量
    let playerHealth = startPlayerHealth;

    let score = 0;

    let verticalSpeedRate = 1;
    let horizontalSpeedRate = 1;
    const bossVerticalSpeed = 1;
    const bossHorizontalSpeed = 1;

    const horizontalSpeed = 2.5;
    const verticalSpeed = 3.5;



    const bullets = [];
    const enemyBullets = [];
    const enemies = [];
    const keys = {};
    var bossAttackMode = 0;
    let isSpacePressed = false;
    let lastShotTime = 0;
    const shootCooldown = 150;

    document.addEventListener('keydown', (e) => {
        keys[e.key] = true;
        if(e.key === ' ') {
            isSpacePressed = true;
            e.preventDefault();
        }
    });

    document.addEventListener('keyup', (e) => {
        keys[e.key] = false;
        if(e.key === ' ') {
            isSpacePressed = false;
        }
    });

    function bossAttackModeChangeLogic()
    {
        bossAttackMode = Math.random();
    }

    // 创建子弹组
    function createBullets() {
        // 子弹间距
        const spacing = 15;

        // 创建三发子弹
        for(let i = -1; i <= 1; i++) {
            const bullet = document.createElement('img');
            bullet.src = './src/img/our_bullet2.png';
            bullet.className = 'bullet';

            // 计算子弹位置，中间子弹在飞机正上方，两侧子弹略微偏移
            const bulletLeft = planeLeft + plane.offsetWidth/2 - 5 + (i * spacing);
            bullet.style.left = bulletLeft + 'px';
            bullet.style.top = (planeTop - 20) + 'px';

            gameContainer.appendChild(bullet);

            // 为两侧子弹添加横向运动
            const horizontalSpeed = i * 0.5; // 子弹横向扩散速度

            bullets.push({
                element: bullet,
                top: planeTop - 20,
                left: bulletLeft,
                horizontalSpeed: horizontalSpeed // 新增横向速度属性
            });
        }
    }

    function bossMoveLogic()
    {
        verticalSpeedRate = 1 - 2 * Math.random();
        horizontalSpeedRate = 1 - 2 * Math.random();
    }

    let Angle = 0;
    function bossAttackLogic()
    {
        if(bossAttackMode <= 0.45) 
        {
            for(let i = 0; i < 20; i++)
            {
                const enemyBullet = document.createElement('img');
                enemyBullet.src = './src/img/boss_bullet2.png';
                enemyBullet.className = 'bullet';
                enemyBullet.style.left = bossLeft + 'px';
                enemyBullet.style.top = bossTop + 'px';
                const horizontalSpeed = Math.cos(i / 20 * 2 * Math.PI);
                const verticalSpeed = Math.sin(i / 20 * 2 * Math.PI);

                gameContainer.appendChild(enemyBullet);

                enemyBullets.push({
                    element: enemyBullet,
                    top: bossTop,
                    left: bossLeft,
                    horizontalSpeed: horizontalSpeed,
                    verticalSpeed: verticalSpeed
                });
            }
        }
        else if(bossAttackMode <= 0.9)
        {
            
            for(let i = 0; i < 20; i++)
            {
                const enemyBullet = document.createElement('img');
                enemyBullet.src = './src/img/boss_bullet2.png';
                enemyBullet.className = 'bullet';
                enemyBullet.style.left = bossLeft + 'px';
                enemyBullet.style.top = bossTop + 'px';
                const horizontalSpeed = Math.cos(i / 20 * 0.5 * Math.PI + Angle/2 * Math.PI);
                const verticalSpeed = Math.sin(i / 20 * 0.5 * Math.PI + Angle/2 * Math.PI);

                gameContainer.appendChild(enemyBullet);

                enemyBullets.push({
                    element: enemyBullet,
                    top: bossTop,
                    left: bossLeft,
                    horizontalSpeed: horizontalSpeed,
                    verticalSpeed: verticalSpeed
                });
            }
            Angle += 1;
            Angle = Angle % 4;

        }
    }

    function createEnemy() {
        const enemy = document.createElement('img');
        enemy.src = './src/img/boss.gif';
        enemy.className = 'enemy';
        enemy.style.left = Math.random() * (gameContainer.offsetWidth - 40) + 'px';
        enemy.style.top = '-40px';
        gameContainer.appendChild(enemy);
        enemies.push({
            element: enemy,
            top: -40
        });
    }

    function isColliding(rect1, rect2) {
        return !(rect1.right < rect2.left ||
            rect1.left > rect2.right ||
            rect1.bottom < rect2.top ||
            rect1.top > rect2.bottom);
    }

    function gameLoop() {
        const currentTime = Date.now();
        //角色移动
        if (isSpacePressed && currentTime - lastShotTime >= shootCooldown) 
        {
            createBullets();
            lastShotTime = currentTime;
        }

        if(keys['ArrowLeft'] && planeLeft > 0) {
            planeLeft -= horizontalSpeed;
        }
        if(keys['ArrowRight'] && planeLeft < gameContainer.offsetWidth - plane.offsetWidth) {
            planeLeft += horizontalSpeed;
        }
        if(keys['ArrowUp'] && planeTop > 0) {
            planeTop -= verticalSpeed;
        }
        if(keys['ArrowDown'] && planeTop < gameContainer.offsetHeight - plane.offsetHeight) {
            planeTop += verticalSpeed;
        }


        // 更新角色位置
        plane.style.left = planeLeft + 'px';
        plane.style.top = planeTop + 'px';

        //boss移动
        if(bossTop < gameContainer.offsetHeight - boss.offsetHeight && verticalSpeedRate > 0)
        {
            bossTop += bossVerticalSpeed * verticalSpeedRate;
        }
        if(bossTop > 0 && verticalSpeedRate < 0)
        {
            bossTop += bossVerticalSpeed* verticalSpeedRate;
        }
        if(bossLeft < gameContainer.offsetWidth - boss.offsetWidth && horizontalSpeedRate > 0)
        {
            bossLeft += bossHorizontalSpeed* horizontalSpeedRate;
        }
        if(bossLeft > 0 && horizontalSpeedRate < 0)
        {
            bossLeft += bossHorizontalSpeed * horizontalSpeedRate;
        }
        //bossTop += verticalSpeed * verticalSpeedRate;
        //bossLeft += horizontalSpeed * horizontalSpeedRate;
        // 更新boss位置
        boss.style.left = bossLeft + 'px';
        boss.style.top = bossTop + 'px';

        // 更新子弹位置
        for(let i = bullets.length - 1; i >= 0; i--) {
            const bullet = bullets[i];
            bullet.top -= 8; // 垂直移动速度
            bullet.left += bullet.horizontalSpeed; // 添加横向移动

            // 更新子弹位置
            bullet.element.style.top = bullet.top + 'px';
            bullet.element.style.left = bullet.left + 'px';

            // 移除超出边界的子弹
            if(bullet.top <= -20 || bullet.left < -10 || bullet.left > gameContainer.offsetWidth) {
                bullet.element.remove();
                bullets.splice(i, 1);
                continue;
            }
            if(isColliding(bullet.element.getBoundingClientRect(),boss.getBoundingClientRect())) 
            {
                bullet.element.remove();
                bullets.splice(i, 1);

                bossHealth -= 1;
                bossHealthElement.textContent = bossHealth;
            }
            if(bossHealth <= 0) 
            {
                alert('游戏结束！\n你赢了！你剩余血量：' + playerHealth);
                location.reload();
                return;
            }
        }

        


        // 更新敌人子弹位置
        for(let i = enemyBullets.length - 1; i >= 0; i--)
        {
            const enemyBullet = enemyBullets[i];
            enemyBullet.top += enemyBullet.verticalSpeed; // 垂直移动速度
            enemyBullet.left += enemyBullet.horizontalSpeed; // 添加横向移动

            // 更新子弹位置
            enemyBullet.element.style.top = enemyBullet.top + 'px';
            enemyBullet.element.style.left = enemyBullet.left + 'px';

            // 移除超出边界的子弹
            if(enemyBullet.top <= -20 || enemyBullet.left < -10 || enemyBullet.left > gameContainer.offsetWidth) {
                enemyBullet.element.remove();
                enemyBullets.splice(i, 1);
                continue;
            }

            if(isColliding(enemyBullet.element.getBoundingClientRect(),plane.getBoundingClientRect()))
            {
                enemyBullet.element.remove();
                enemyBullets.splice(i, 1);

                playerHealth -= 1;
                playerHealthElement.textContent = playerHealth;

            }
            if(playerHealth <= 0) 
            {
                alert('游戏结束！\n你ga了！敌人剩余血量：' + bossHealth);
                location.reload();
                return;
            }
        }


        // 敌机移动
        for(let i = enemies.length - 1; i >= 0; i--) {
            const enemy = enemies[i];
            enemy.top += 2;
            enemy.element.style.top = enemy.top + 'px';

            if(enemy.top >= gameContainer.offsetHeight) {
                enemy.element.remove();
                enemies.splice(i, 1);
                continue;
            }

            if(isColliding(enemy.element.getBoundingClientRect(),
                plane.getBoundingClientRect())) {
                alert('游戏结束！\n最终得分：' + score);
                location.reload();
                return;
            }
        }

        requestAnimationFrame(gameLoop);
    }

    //setInterval(createEnemy, 1500);
    setInterval(bossMoveLogic, 150);
    setInterval(bossAttackLogic, 1000);
    setInterval(bossAttackModeChangeLogic,5000);
    gameLoop();
</script>
</body>
</html>
